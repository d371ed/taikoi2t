# taikoi2t

ゲーム「ブルーアーカイブ」 (日本語版) 戦術対抗戦リザルトのスクリーンショットから, 編成データを画像認識で抽出します.

```sh
> poetry run taikoi2t -d .\students.csv .\Screenshot_2025.04.01_00.00.00.000.png .\Screenshot_2025.04.01_01.00.00.000.png
TRUE    ホシノ  バネル  マリナ  アジュリ        水シロコ        ヒビキ  水ハナコ        マリナ  シロコ＊        ホシノ  水シロコ        ヒビキ
FALSE    イオリ  ホシノ  シロコ＊        シュン  水シロコ        佐天涙子        ホシノ  シロコ＊        マリナ  レイサ  水シロコ        ヒビキ
```

出力は Google スプレッドシートへ貼り付けることを想定して TSV になります.

- 動画のフレーム保存など多少画質の低い画像へ対応
  - 生徒名辞書から生徒名を構成する文字のみを認識対象に
  - 編集距離 (Levenshtein) による生徒名のマッチングで誤検出を補正
  - 取りこぼしやすい濁点を濁点除去したスコアでの比較で補正
- 外部 CSV ファイルによる追加生徒対応
- 生徒名の略称変換
- スペシャルの左右を辞書順に統一
- 勝敗の取得
- 対戦相手名の取得 (`--opponent` オプション)

**※注意** [PyTorch](https://pytorch.org/) のインストールにより 4.3GB 以上のストレージ容量が必要になるはずです. CPU 版に変更することで省容量化は可能ですが, 実行速度が大きく低下します.
また GPU が CUDA 12.4 をサポートしていない場合もおそらく実行速度が低下する (あるいは実行自体が不能) と予想されます.

**※注意** 該当ゲーム画面の UI が変更された場合抽出が不能になります. 2025年4月次点の UI に基づいて設計されています.


## インストール

事前に [Python](https://www.python.org/) 3.13 と [Poetry](https://python-poetry.org/) のインストールが必要です.

```sh
> cd path\to\taikoi2t\
> poetry install
```

CUDA 版 [PyTorch](https://pytorch.org/) を利用しているため, かなり容量の大きいダウンロードが発生するはずです.


## 使い方

```
usage: taikoi2t [-h] -d DICTIONARY [--opponent] [-v] files [files ...]

positional arguments:
  files                 target images

options:
  -h, --help            show this help message and exit
  -d, --dictionary DICTIONARY
                        student dictionary (CSV)
  --opponent            include the name of opponent
  -v, --verbose         print messages and show images for debug (default: silent, -v: error, -vv: print, -vvv: image)
```

### コマンド例

```sh
> poetry run taikoi2t -d .\students.csv .\Screenshot_2025.04.01_00.00.00.000.png .\videoframe_100000.jpg
```

以下のようにすると対戦相手名を出力に含むようになります.

```sh
> poetry run taikoi2t -d .\students.csv --opponent .\Screenshot_2025.04.01_00.00.00.000.png
```

### `-d, --dictionary`

必須.
生徒名と別名を記述した辞書ファイルを指定します.

ヘッダ行を含まない CSV で, `ゲーム中の生徒名表記,出力時変換したい略称` の2列で記述されている必要があります.

```csv
シロコ（水着）,水シロコ
アイリ,
アイリ（バンド）,バアイリ
アオバ,
...
```

略称が不要な場合は, 空文字列にすることでそのままの生徒名を出力します.

また, **並び順はスペシャル生徒のソートに利用** するため, 優先して左側に配置したい生徒はより先に記述してください.

### `-opponent`

任意.
指定すると対戦相手 (右側) の名前を検出し, 右側チームの前の列に挿入します.

小書き文字 (っ, ゃ, ぃ 等) や濁音/半濁音 (が, ぱ 等), 日本語外の漢字は検出精度が低い傾向にあります.

### `-v, --verbose`

任意.
デバッグ用の出力へ切り替えます.

#### デフォルト (指定なし)

Silent. 通常の解析結果を返すモード.
致命的なエラーを除き stderr へも出力を行いません.

画像単位でエラーがあった場合, 実行を継続しつつ stdout へすべて空文字列の TSV 行を出力します.

#### `-v` または `--verbose`

Error. エラーと警告を stderr へ出力するモード.

画像単位でエラーがあった場合に実行は継続されますが, stderr へエラーを出力します.

#### `-vv`

Print. stdout へデバッグ用の情報を詳細に出力するモード.

#### `-vvv`

Image. Print の内容に加え `cv2.imshow` で画像解析の途中経過を表示するモード.

### `-h, --help`

上記ヘルプを表示します.

### `files`

1つ以上必須.
解析対象となる画像のパスを指定します. ワイルドカードには非対応です.

複数渡された場合, 左から順に解析し結果を1画像あたり1行ずつ出力します.
何らかのエラーで抽出が失敗した場合, すべて空文字列の行が出力されます.

### 出力

以下の形式で出力されます. (区切り文字はスペースに置換してありますが実際はタブ文字 \t です.)

```
勝敗 L1 L2 L3 L4 LSP1 LSP2 (対戦相手) R1 R2 R3 R4 RSP1 RSP2
```

#### 勝敗

`TRUE` or `FALSE`.
左側のチームが勝利の場合 `TRUE` です.

### L1 ～ L4

`str`.
左側のチームのストライカー生徒名 (略称) です. 攻撃のログなら A1 ～ A4, 防御のログなら D1 ～ D4 です.

### LSP1, LSP2

`str`.
左側のチームのスペシャル生徒名 (略称) です. 与えた辞書ファイルの順に左右が調整されます.

### (対戦相手)

`str`. (`--opponent` オプション指定時のみ.)
対戦相手 (右側のチーム) の先生名です.

### R1 ～ R4

`str`.
右側のチームのストライカー生徒名 (略称) です. 攻撃のログなら D1 ～ D4, 防御のログなら A1 ～ A4 です.

### RSP1, RSP2

`str`.
右側のチームのスペシャル生徒名 (略称) です. 与えた辞書ファイルの順に左右が調整されます.


## 辞書ファイルのメンテナンス

`-d, --dictionary` に与える生徒名辞書を `students.csv` として同梱しています.

新たに生徒が追加された場合にはこのファイルに追加する必要があります.
精度向上のため, **この辞書に無い生徒名は検出が不可能** です.

また, 出力される生徒略称を変更したい場合もこのファイルを編集してください.


## フロントエンドスクリプト

`frontend` ディレクトリ下に Windows 環境での利用例となるスクリプトがあります.
バッチファイル (.bat) をダブルクリックで起動することを想定しています.


## できないこと

- 各生徒のダメージ数値の抽出
- アイコンによる攻撃側/防御側の判定
- 左側部隊 (プレイヤー側) の名前検出
- 片方あるいは両方のチームが5人以下の場合の抽出 (エラーになります)
- `ホシノ（臨戦）` のタイプ判定
- 大きくアスペクト比の狂った画像からの抽出
- TSV 以外の出力形式
- 列入れ替えやフォーマット文字列など, 出力形式のカスタマイズ

需要があれば対応できるかもしれません.


## 制作者の実行環境

- Windows 11 Home 24H2
- Python 3.13.2
- Core i5-9600K
- RAM 16GB
- GeForce GTX 1060 6GB
- GeForce Driver 32.0.15.6094


## 免責等

本ソフトウェアはゲーム「ブルーアーカイブ」の開発元の Nexon Games 社および日本語版パブリッシャーの Yostar 社とは無関係です.

本ソフトウェアは直接ゲームプレイへ何も作用しないものではありますが, 利用規約 (特に 第11条 (13) 項) へ抵触すると権利者さまが判断された場合, 即時公開を停止いたします.
